{"ast":null,"code":"function _toConsumableArray(arr) {\n  return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread();\n}\n\nfunction _nonIterableSpread() {\n  throw new TypeError(\"Invalid attempt to spread non-iterable instance\");\n}\n\nfunction _iterableToArray(iter) {\n  if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter);\n}\n\nfunction _arrayWithoutHoles(arr) {\n  if (Array.isArray(arr)) {\n    for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) {\n      arr2[i] = arr[i];\n    }\n\n    return arr2;\n  }\n}\n\nfunction _slicedToArray(arr, i) {\n  return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest();\n}\n\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n}\n\nfunction _iterableToArrayLimit(arr, i) {\n  if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === \"[object Arguments]\")) {\n    return;\n  }\n\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n  var _e = undefined;\n\n  try {\n    for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n\n  return _arr;\n}\n\nfunction _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nfunction _objectWithoutProperties(source, excluded) {\n  if (source == null) return {};\n\n  var target = _objectWithoutPropertiesLoose(source, excluded);\n\n  var key, i;\n\n  if (Object.getOwnPropertySymbols) {\n    var sourceSymbolKeys = Object.getOwnPropertySymbols(source);\n\n    for (i = 0; i < sourceSymbolKeys.length; i++) {\n      key = sourceSymbolKeys[i];\n      if (excluded.indexOf(key) >= 0) continue;\n      if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue;\n      target[key] = source[key];\n    }\n  }\n\n  return target;\n}\n\nfunction _objectWithoutPropertiesLoose(source, excluded) {\n  if (source == null) return {};\n  var target = {};\n  var sourceKeys = Object.keys(source);\n  var key, i;\n\n  for (i = 0; i < sourceKeys.length; i++) {\n    key = sourceKeys[i];\n    if (excluded.indexOf(key) >= 0) continue;\n    target[key] = source[key];\n  }\n\n  return target;\n}\n\nimport useRequest from '@umijs/use-request';\nimport { useState, useCallback, useEffect, useRef } from 'react';\nimport { CombineService, PaginatedParams, BasePaginatedOptions, PaginatedOptionsWithFormat, PaginatedFormatReturn, PaginatedResult } from '@umijs/use-request/lib/types';\nimport useUpdateEffect from '../useUpdateEffect';\nimport usePersistFn from '../usePersistFn';\nexport { CombineService, PaginatedParams, BasePaginatedOptions, PaginatedOptionsWithFormat, PaginatedFormatReturn, PaginatedResult };\n\nfunction useFormTable(service, options) {\n  var form = options.form,\n      _options$refreshDeps = options.refreshDeps,\n      refreshDeps = _options$refreshDeps === void 0 ? [] : _options$refreshDeps,\n      manual = options.manual,\n      restOptions = _objectWithoutProperties(options, [\"form\", \"refreshDeps\", \"manual\"]);\n\n  var result = useRequest(service, _objectSpread({}, restOptions, {\n    paginated: true,\n    manual: true\n  }));\n  var params = result.params,\n      run = result.run;\n  var cacheFormTableData = params[2] || {}; // 优先从缓存中读\n\n  var _useState = useState(cacheFormTableData.type || 'simple'),\n      _useState2 = _slicedToArray(_useState, 2),\n      type = _useState2[0],\n      setType = _useState2[1]; // 全量 form 数据，包括 simple 和 advance\n\n\n  var _useState3 = useState(cacheFormTableData.allFormData || {}),\n      _useState4 = _slicedToArray(_useState3, 2),\n      allFormData = _useState4[0],\n      setAllFormData = _useState4[1]; // 获取当前展示的 form 字段值\n\n\n  var getActivetFieldValues = useCallback(function () {\n    if (!form) {\n      return {};\n    } // antd 3\n\n\n    if (form.getFieldInstance) {\n      var tempAllFiledsValue = form.getFieldsValue();\n      var filterFiledsValue = {};\n      Object.keys(tempAllFiledsValue).forEach(function (key) {\n        if (form.getFieldInstance ? form.getFieldInstance(key) : true) {\n          filterFiledsValue[key] = tempAllFiledsValue[key];\n        }\n      });\n      return filterFiledsValue;\n    } // antd 4\n\n\n    return form.getFieldsValue(null, function () {\n      return true;\n    });\n  }, [form]);\n  var formRef = useRef(form);\n  formRef.current = form;\n  /* 初始化，或改变了 searchType, 恢复表单数据 */\n\n  useEffect(function () {\n    if (!formRef.current) {\n      return;\n    } // antd 3\n\n\n    if (formRef.current.getFieldInstance) {\n      // antd 3 需要判断字段是否存在，否则会抛警告\n      var filterFiledsValue = {};\n      Object.keys(allFormData).forEach(function (key) {\n        if (formRef.current.getFieldInstance ? formRef.current.getFieldInstance(key) : true) {\n          filterFiledsValue[key] = allFormData[key];\n        }\n      });\n      formRef.current.setFieldsValue(filterFiledsValue);\n    } else {\n      // antd 4\n      formRef.current.setFieldsValue(allFormData);\n    }\n  }, [type]); // 首次加载，手动提交。为了拿到 form 的 initial values\n\n  useEffect(function () {\n    // 如果有缓存，则使用缓存，重新请求\n    if (params.length > 0) {\n      run.apply(void 0, _toConsumableArray(params));\n      return;\n    } // 如果没有缓存，触发 submit\n\n\n    if (!manual) {\n      submit();\n    }\n  }, []);\n  var changeType = useCallback(function () {\n    var currentFormData = getActivetFieldValues();\n    setAllFormData(_objectSpread({}, allFormData, {}, currentFormData));\n    var targetType = type === 'simple' ? 'advance' : 'simple';\n    setType(targetType);\n  }, [type, allFormData, getActivetFieldValues]);\n  var submit = useCallback(function (e) {\n    if (e === null || e === void 0 ? void 0 : e.preventDefault) {\n      e.preventDefault();\n    }\n\n    setTimeout(function () {\n      var activeFormData = getActivetFieldValues(); // 记录全量数据\n\n      var _allFormData = _objectSpread({}, allFormData, {}, activeFormData);\n\n      setAllFormData(_allFormData);\n      run(_objectSpread({\n        pageSize: options.defaultPageSize || 10\n      }, params[0] || {}, {\n        // 防止 manual 情况下，第一次触发 submit，此时没有 params[0]\n        current: 1\n      }), activeFormData, {\n        allFormData: _allFormData,\n        type: type\n      });\n    });\n  }, [getActivetFieldValues, run, params, allFormData, type]);\n  var reset = useCallback(function () {\n    if (form) {\n      form.resetFields();\n    }\n\n    submit();\n  }, [form, submit]);\n  var resetPersistFn = usePersistFn(reset); // refreshDeps 变化，reset。\n\n  useUpdateEffect(function () {\n    if (!manual) {\n      resetPersistFn();\n    }\n  }, _toConsumableArray(refreshDeps));\n  return _objectSpread({}, result, {\n    search: {\n      submit: submit,\n      type: type,\n      changeType: changeType,\n      reset: reset\n    }\n  });\n}\n\nexport default useFormTable;","map":{"version":3,"sources":["E:/github-project/cloudMusic-mobile/node_modules/@umijs/hooks/es/useFormTable/index.js"],"names":["_toConsumableArray","arr","_arrayWithoutHoles","_iterableToArray","_nonIterableSpread","TypeError","iter","Symbol","iterator","Object","prototype","toString","call","Array","from","isArray","i","arr2","length","_slicedToArray","_arrayWithHoles","_iterableToArrayLimit","_nonIterableRest","_arr","_n","_d","_e","undefined","_i","_s","next","done","push","value","err","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","apply","_objectSpread","target","arguments","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","obj","configurable","writable","_objectWithoutProperties","excluded","_objectWithoutPropertiesLoose","sourceSymbolKeys","indexOf","propertyIsEnumerable","sourceKeys","useRequest","useState","useCallback","useEffect","useRef","CombineService","PaginatedParams","BasePaginatedOptions","PaginatedOptionsWithFormat","PaginatedFormatReturn","PaginatedResult","useUpdateEffect","usePersistFn","useFormTable","service","options","form","_options$refreshDeps","refreshDeps","manual","restOptions","result","paginated","params","run","cacheFormTableData","_useState","type","_useState2","setType","_useState3","allFormData","_useState4","setAllFormData","getActivetFieldValues","getFieldInstance","tempAllFiledsValue","getFieldsValue","filterFiledsValue","formRef","current","setFieldsValue","submit","changeType","currentFormData","targetType","e","preventDefault","setTimeout","activeFormData","_allFormData","pageSize","defaultPageSize","reset","resetFields","resetPersistFn","search"],"mappings":"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","sourcesContent":["function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }\n\nfunction _nonIterableSpread() { throw new TypeError(\"Invalid attempt to spread non-iterable instance\"); }\n\nfunction _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter); }\n\nfunction _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }\n\nfunction _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); }\n\nfunction _iterableToArrayLimit(arr, i) { if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === \"[object Arguments]\")) { return; } var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport useRequest from '@umijs/use-request';\nimport { useState, useCallback, useEffect, useRef } from 'react';\nimport { CombineService, PaginatedParams, BasePaginatedOptions, PaginatedOptionsWithFormat, PaginatedFormatReturn, PaginatedResult } from '@umijs/use-request/lib/types';\nimport useUpdateEffect from '../useUpdateEffect';\nimport usePersistFn from '../usePersistFn';\nexport { CombineService, PaginatedParams, BasePaginatedOptions, PaginatedOptionsWithFormat, PaginatedFormatReturn, PaginatedResult };\n\nfunction useFormTable(service, options) {\n  var form = options.form,\n      _options$refreshDeps = options.refreshDeps,\n      refreshDeps = _options$refreshDeps === void 0 ? [] : _options$refreshDeps,\n      manual = options.manual,\n      restOptions = _objectWithoutProperties(options, [\"form\", \"refreshDeps\", \"manual\"]);\n\n  var result = useRequest(service, _objectSpread({}, restOptions, {\n    paginated: true,\n    manual: true\n  }));\n  var params = result.params,\n      run = result.run;\n  var cacheFormTableData = params[2] || {}; // 优先从缓存中读\n\n  var _useState = useState(cacheFormTableData.type || 'simple'),\n      _useState2 = _slicedToArray(_useState, 2),\n      type = _useState2[0],\n      setType = _useState2[1]; // 全量 form 数据，包括 simple 和 advance\n\n\n  var _useState3 = useState(cacheFormTableData.allFormData || {}),\n      _useState4 = _slicedToArray(_useState3, 2),\n      allFormData = _useState4[0],\n      setAllFormData = _useState4[1]; // 获取当前展示的 form 字段值\n\n\n  var getActivetFieldValues = useCallback(function () {\n    if (!form) {\n      return {};\n    } // antd 3\n\n\n    if (form.getFieldInstance) {\n      var tempAllFiledsValue = form.getFieldsValue();\n      var filterFiledsValue = {};\n      Object.keys(tempAllFiledsValue).forEach(function (key) {\n        if (form.getFieldInstance ? form.getFieldInstance(key) : true) {\n          filterFiledsValue[key] = tempAllFiledsValue[key];\n        }\n      });\n      return filterFiledsValue;\n    } // antd 4\n\n\n    return form.getFieldsValue(null, function () {\n      return true;\n    });\n  }, [form]);\n  var formRef = useRef(form);\n  formRef.current = form;\n  /* 初始化，或改变了 searchType, 恢复表单数据 */\n\n  useEffect(function () {\n    if (!formRef.current) {\n      return;\n    } // antd 3\n\n\n    if (formRef.current.getFieldInstance) {\n      // antd 3 需要判断字段是否存在，否则会抛警告\n      var filterFiledsValue = {};\n      Object.keys(allFormData).forEach(function (key) {\n        if (formRef.current.getFieldInstance ? formRef.current.getFieldInstance(key) : true) {\n          filterFiledsValue[key] = allFormData[key];\n        }\n      });\n      formRef.current.setFieldsValue(filterFiledsValue);\n    } else {\n      // antd 4\n      formRef.current.setFieldsValue(allFormData);\n    }\n  }, [type]); // 首次加载，手动提交。为了拿到 form 的 initial values\n\n  useEffect(function () {\n    // 如果有缓存，则使用缓存，重新请求\n    if (params.length > 0) {\n      run.apply(void 0, _toConsumableArray(params));\n      return;\n    } // 如果没有缓存，触发 submit\n\n\n    if (!manual) {\n      submit();\n    }\n  }, []);\n  var changeType = useCallback(function () {\n    var currentFormData = getActivetFieldValues();\n    setAllFormData(_objectSpread({}, allFormData, {}, currentFormData));\n    var targetType = type === 'simple' ? 'advance' : 'simple';\n    setType(targetType);\n  }, [type, allFormData, getActivetFieldValues]);\n  var submit = useCallback(function (e) {\n    if (e === null || e === void 0 ? void 0 : e.preventDefault) {\n      e.preventDefault();\n    }\n\n    setTimeout(function () {\n      var activeFormData = getActivetFieldValues(); // 记录全量数据\n\n      var _allFormData = _objectSpread({}, allFormData, {}, activeFormData);\n\n      setAllFormData(_allFormData);\n      run(_objectSpread({\n        pageSize: options.defaultPageSize || 10\n      }, params[0] || {}, {\n        // 防止 manual 情况下，第一次触发 submit，此时没有 params[0]\n        current: 1\n      }), activeFormData, {\n        allFormData: _allFormData,\n        type: type\n      });\n    });\n  }, [getActivetFieldValues, run, params, allFormData, type]);\n  var reset = useCallback(function () {\n    if (form) {\n      form.resetFields();\n    }\n\n    submit();\n  }, [form, submit]);\n  var resetPersistFn = usePersistFn(reset); // refreshDeps 变化，reset。\n\n  useUpdateEffect(function () {\n    if (!manual) {\n      resetPersistFn();\n    }\n  }, _toConsumableArray(refreshDeps));\n  return _objectSpread({}, result, {\n    search: {\n      submit: submit,\n      type: type,\n      changeType: changeType,\n      reset: reset\n    }\n  });\n}\n\nexport default useFormTable;"]},"metadata":{},"sourceType":"module"}