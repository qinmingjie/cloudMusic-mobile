{"ast":null,"code":"function _slicedToArray(arr, i) {\n  return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest();\n}\n\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n}\n\nfunction _iterableToArrayLimit(arr, i) {\n  if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === \"[object Arguments]\")) {\n    return;\n  }\n\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n  var _e = undefined;\n\n  try {\n    for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n\n  return _arr;\n}\n\nfunction _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}\n\nfunction _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") {\n    _typeof = function _typeof(obj) {\n      return typeof obj;\n    };\n  } else {\n    _typeof = function _typeof(obj) {\n      return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n  }\n\n  return _typeof(obj);\n}\n\nimport { useEffect, useState, useCallback, useRef } from 'react';\nimport useUpdateEffect from '../useUpdateEffect';\nimport useAsync from '../useAsync';\n\nfunction useLoadMore(fn, deps, options) {\n  var _deps = Array.isArray(deps) ? deps : [];\n\n  var _options = _typeof(deps) === 'object' && !Array.isArray(deps) ? deps : options || {};\n  /* 初始化值 */\n\n\n  var itemKey = _options.itemKey,\n      _options$initPageSize = _options.initPageSize,\n      initPageSize = _options$initPageSize === void 0 ? 10 : _options$initPageSize,\n      formatResult = _options.formatResult,\n      ref = _options.ref,\n      _options$threshold = _options.threshold,\n      threshold = _options$threshold === void 0 ? 100 : _options$threshold;\n  var incrementSize = _options.incrementSize;\n\n  if (!incrementSize) {\n    incrementSize = initPageSize;\n  }\n\n  var _useState = useState(1),\n      _useState2 = _slicedToArray(_useState, 2),\n      page = _useState2[0],\n      setPage = _useState2[1];\n\n  var _useState3 = useState(),\n      _useState4 = _slicedToArray(_useState3, 2),\n      total = _useState4[0],\n      setTotal = _useState4[1];\n\n  var _useState5 = useState([]),\n      _useState6 = _slicedToArray(_useState5, 2),\n      data = _useState6[0],\n      setData = _useState6[1];\n  /* 控制重新执行 */\n\n\n  var _useState7 = useState(0),\n      _useState8 = _slicedToArray(_useState7, 2),\n      count = _useState8[0],\n      setCount = _useState8[1];\n  /* 开始的时间戳 */\n\n\n  var startTime = useRef(new Date().getTime());\n\n  var _useAsync = useAsync(fn, [], {\n    manual: true\n  }),\n      run = _useAsync.run,\n      loading = _useAsync.loading;\n  /* id 模式下读取 Key */\n\n\n  var getItemKey = useCallback(function (item, index) {\n    var key = typeof itemKey === 'function' ? itemKey(item, index) : item[itemKey];\n    return key === undefined ? index : key;\n  }, [itemKey]);\n  var loadData = useCallback(function () {\n    var params = {\n      page: page,\n      pageSize: page === 1 ? initPageSize : incrementSize,\n      offset: data.length,\n      startTime: startTime.current\n    };\n    /* id 模式需要增加最后一个 id */\n\n    if (itemKey) {\n      params.id = data.length > 0 ? getItemKey(data[data.length - 1], data.length - 1) : undefined;\n    }\n\n    run(params).then(function (result) {\n      if (!result) {\n        return;\n      }\n\n      var _ref = formatResult ? formatResult(result) : result,\n          currentTotal = _ref.total,\n          currentData = _ref.data;\n\n      setData(data.concat(currentData));\n      setTotal(currentTotal);\n    });\n  }, [page, initPageSize, incrementSize, data]);\n  var loadMore = useCallback(function () {\n    if (total && data.length >= total) {\n      return;\n    }\n\n    setPage(page + 1);\n    setCount(count + 1);\n  }, [page, count, data, total]);\n  var reload = useCallback(function () {\n    setPage(1);\n    setData([]);\n    startTime.current = new Date().getTime();\n    setCount(count + 1);\n  }, [count]);\n  /* 上拉加载的方法 */\n\n  var scrollMethod = useCallback(function () {\n    if (loading || !ref || !ref.current) {\n      return;\n    }\n\n    if (ref.current.scrollHeight - ref.current.scrollTop <= ref.current.clientHeight + threshold) {\n      loadMore();\n    }\n  }, [loading, ref, loadMore]);\n  /* 如果有 ref，则会上拉加载更多 */\n\n  useEffect(function () {\n    if (!ref || !ref.current) {\n      return function () {};\n    }\n\n    ref.current.addEventListener('scroll', scrollMethod);\n    return function () {\n      if (ref && ref.current) {\n        ref.current.removeEventListener('scroll', scrollMethod);\n      }\n    };\n  }, [scrollMethod]);\n  /* 只有初始化，或者 count 变化时，才会执行 run */\n\n  useEffect(function () {\n    loadData();\n  }, [count]);\n  /* deps 变化后，重新 reload */\n\n  useUpdateEffect(function () {\n    reload();\n  }, _deps);\n  return {\n    data: data,\n    loading: loading && page === 1,\n    loadingMore: loading && page > 1,\n    reload: reload,\n    loadMore: loadMore,\n    total: total,\n    noMore: !loading && !total || !!total && data.length >= total\n  };\n}\n\nexport default useLoadMore;","map":{"version":3,"sources":["E:/github-project/cloudMusic-mobile/node_modules/@umijs/hooks/es/useLoadMore/index.js"],"names":["_slicedToArray","arr","i","_arrayWithHoles","_iterableToArrayLimit","_nonIterableRest","TypeError","Symbol","iterator","Object","prototype","toString","call","_arr","_n","_d","_e","undefined","_i","_s","next","done","push","value","length","err","Array","isArray","_typeof","obj","constructor","useEffect","useState","useCallback","useRef","useUpdateEffect","useAsync","useLoadMore","fn","deps","options","_deps","_options","itemKey","_options$initPageSize","initPageSize","formatResult","ref","_options$threshold","threshold","incrementSize","_useState","_useState2","page","setPage","_useState3","_useState4","total","setTotal","_useState5","_useState6","data","setData","_useState7","_useState8","count","setCount","startTime","Date","getTime","_useAsync","manual","run","loading","getItemKey","item","index","key","loadData","params","pageSize","offset","current","id","then","result","_ref","currentTotal","currentData","concat","loadMore","reload","scrollMethod","scrollHeight","scrollTop","clientHeight","addEventListener","removeEventListener","loadingMore","noMore"],"mappings":"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","sourcesContent":["function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); }\n\nfunction _iterableToArrayLimit(arr, i) { if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === \"[object Arguments]\")) { return; } var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\nfunction _typeof(obj) { \"@babel/helpers - typeof\"; if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\nimport { useEffect, useState, useCallback, useRef } from 'react';\nimport useUpdateEffect from '../useUpdateEffect';\nimport useAsync from '../useAsync';\n\nfunction useLoadMore(fn, deps, options) {\n  var _deps = Array.isArray(deps) ? deps : [];\n\n  var _options = _typeof(deps) === 'object' && !Array.isArray(deps) ? deps : options || {};\n  /* 初始化值 */\n\n\n  var itemKey = _options.itemKey,\n      _options$initPageSize = _options.initPageSize,\n      initPageSize = _options$initPageSize === void 0 ? 10 : _options$initPageSize,\n      formatResult = _options.formatResult,\n      ref = _options.ref,\n      _options$threshold = _options.threshold,\n      threshold = _options$threshold === void 0 ? 100 : _options$threshold;\n  var incrementSize = _options.incrementSize;\n\n  if (!incrementSize) {\n    incrementSize = initPageSize;\n  }\n\n  var _useState = useState(1),\n      _useState2 = _slicedToArray(_useState, 2),\n      page = _useState2[0],\n      setPage = _useState2[1];\n\n  var _useState3 = useState(),\n      _useState4 = _slicedToArray(_useState3, 2),\n      total = _useState4[0],\n      setTotal = _useState4[1];\n\n  var _useState5 = useState([]),\n      _useState6 = _slicedToArray(_useState5, 2),\n      data = _useState6[0],\n      setData = _useState6[1];\n  /* 控制重新执行 */\n\n\n  var _useState7 = useState(0),\n      _useState8 = _slicedToArray(_useState7, 2),\n      count = _useState8[0],\n      setCount = _useState8[1];\n  /* 开始的时间戳 */\n\n\n  var startTime = useRef(new Date().getTime());\n\n  var _useAsync = useAsync(fn, [], {\n    manual: true\n  }),\n      run = _useAsync.run,\n      loading = _useAsync.loading;\n  /* id 模式下读取 Key */\n\n\n  var getItemKey = useCallback(function (item, index) {\n    var key = typeof itemKey === 'function' ? itemKey(item, index) : item[itemKey];\n    return key === undefined ? index : key;\n  }, [itemKey]);\n  var loadData = useCallback(function () {\n    var params = {\n      page: page,\n      pageSize: page === 1 ? initPageSize : incrementSize,\n      offset: data.length,\n      startTime: startTime.current\n    };\n    /* id 模式需要增加最后一个 id */\n\n    if (itemKey) {\n      params.id = data.length > 0 ? getItemKey(data[data.length - 1], data.length - 1) : undefined;\n    }\n\n    run(params).then(function (result) {\n      if (!result) {\n        return;\n      }\n\n      var _ref = formatResult ? formatResult(result) : result,\n          currentTotal = _ref.total,\n          currentData = _ref.data;\n\n      setData(data.concat(currentData));\n      setTotal(currentTotal);\n    });\n  }, [page, initPageSize, incrementSize, data]);\n  var loadMore = useCallback(function () {\n    if (total && data.length >= total) {\n      return;\n    }\n\n    setPage(page + 1);\n    setCount(count + 1);\n  }, [page, count, data, total]);\n  var reload = useCallback(function () {\n    setPage(1);\n    setData([]);\n    startTime.current = new Date().getTime();\n    setCount(count + 1);\n  }, [count]);\n  /* 上拉加载的方法 */\n\n  var scrollMethod = useCallback(function () {\n    if (loading || !ref || !ref.current) {\n      return;\n    }\n\n    if (ref.current.scrollHeight - ref.current.scrollTop <= ref.current.clientHeight + threshold) {\n      loadMore();\n    }\n  }, [loading, ref, loadMore]);\n  /* 如果有 ref，则会上拉加载更多 */\n\n  useEffect(function () {\n    if (!ref || !ref.current) {\n      return function () {};\n    }\n\n    ref.current.addEventListener('scroll', scrollMethod);\n    return function () {\n      if (ref && ref.current) {\n        ref.current.removeEventListener('scroll', scrollMethod);\n      }\n    };\n  }, [scrollMethod]);\n  /* 只有初始化，或者 count 变化时，才会执行 run */\n\n  useEffect(function () {\n    loadData();\n  }, [count]);\n  /* deps 变化后，重新 reload */\n\n  useUpdateEffect(function () {\n    reload();\n  }, _deps);\n  return {\n    data: data,\n    loading: loading && page === 1,\n    loadingMore: loading && page > 1,\n    reload: reload,\n    loadMore: loadMore,\n    total: total,\n    noMore: !loading && !total || !!total && data.length >= total\n  };\n}\n\nexport default useLoadMore;"]},"metadata":{},"sourceType":"module"}