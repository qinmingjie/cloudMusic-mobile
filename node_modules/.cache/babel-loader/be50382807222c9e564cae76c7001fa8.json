{"ast":null,"code":"function _slicedToArray(arr, i) {\n  return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest();\n}\n\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n}\n\nfunction _iterableToArrayLimit(arr, i) {\n  if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === \"[object Arguments]\")) {\n    return;\n  }\n\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n  var _e = undefined;\n\n  try {\n    for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n\n  return _arr;\n}\n\nfunction _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}\n\nfunction _toConsumableArray(arr) {\n  return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread();\n}\n\nfunction _nonIterableSpread() {\n  throw new TypeError(\"Invalid attempt to spread non-iterable instance\");\n}\n\nfunction _iterableToArray(iter) {\n  if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter);\n}\n\nfunction _arrayWithoutHoles(arr) {\n  if (Array.isArray(arr)) {\n    for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) {\n      arr2[i] = arr[i];\n    }\n\n    return arr2;\n  }\n}\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nimport debounce from 'lodash.debounce';\nimport throttle from 'lodash.throttle';\nimport { useCallback, useEffect, useRef, useState } from 'react';\nimport { isDocumentVisible } from './utils';\nimport { getCache, setCache } from './utils/cache';\nimport limit from './utils/limit';\nimport usePersistFn from './utils/usePersistFn';\nimport useUpdateEffect from './utils/useUpdateEffect';\nimport subscribeFocus from './utils/windowFocus';\nimport subscribeVisible from './utils/windowVisible';\nvar DEFAULT_KEY = 'UMIJS_USE_API_DEFAULT_KEY';\n\nvar Fetch = /*#__PURE__*/function () {\n  // 请求时序\n  // 是否卸载\n  // visible 后，是否继续轮询\n  function Fetch(service, config, subscribe, initState) {\n    _classCallCheck(this, Fetch);\n\n    this.config = void 0;\n    this.service = void 0;\n    this.count = 0;\n    this.unmountedFlag = false;\n    this.pollingWhenVisibleFlag = false;\n    this.pollingTimer = undefined;\n    this.loadingDelayTimer = undefined;\n    this.subscribe = void 0;\n    this.unsubscribe = [];\n    this.that = this;\n    this.state = {\n      loading: false,\n      params: [],\n      data: undefined,\n      error: undefined,\n      run: this.run.bind(this.that),\n      mutate: this.mutate.bind(this.that),\n      refresh: this.refresh.bind(this.that),\n      cancel: this.cancel.bind(this.that),\n      unmount: this.unmount.bind(this.that)\n    };\n    this.debounceRun = void 0;\n    this.throttleRun = void 0;\n    this.limitRefresh = void 0;\n    this.service = service;\n    this.config = config;\n    this.subscribe = subscribe;\n\n    if (initState) {\n      this.state = _objectSpread({}, this.state, {}, initState);\n    }\n\n    this.debounceRun = this.config.debounceInterval ? debounce(this._run, this.config.debounceInterval) : undefined;\n    this.throttleRun = this.config.throttleInterval ? throttle(this._run, this.config.throttleInterval) : undefined;\n    this.limitRefresh = limit(this.refresh.bind(this), this.config.focusTimespan);\n\n    if (this.config.pollingInterval) {\n      this.unsubscribe.push(subscribeVisible(this.rePolling.bind(this)));\n    }\n\n    if (this.config.refreshOnWindowFocus) {\n      this.unsubscribe.push(subscribeFocus(this.limitRefresh.bind(this)));\n    }\n  }\n\n  _createClass(Fetch, [{\n    key: \"setState\",\n    value: function setState() {\n      var s = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      this.state = _objectSpread({}, this.state, {}, s);\n      this.subscribe(this.state);\n    }\n  }, {\n    key: \"_run\",\n    value: function _run() {\n      var _this = this;\n\n      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n        args[_key] = arguments[_key];\n      } // 取消已有定时器\n\n\n      if (this.pollingTimer) {\n        clearTimeout(this.pollingTimer);\n      } // 取消 loadingDelayTimer\n\n\n      if (this.loadingDelayTimer) {\n        clearTimeout(this.loadingDelayTimer);\n      }\n\n      this.count += 1; // 闭包存储当次请求的 count\n\n      var currentCount = this.count;\n      this.setState({\n        loading: !this.config.loadingDelay,\n        params: args\n      });\n\n      if (this.config.loadingDelay) {\n        this.loadingDelayTimer = setTimeout(function () {\n          _this.setState({\n            loading: true\n          });\n        }, this.config.loadingDelay);\n      }\n\n      return this.service.apply(this, args).then(function (res) {\n        if (!_this.unmountedFlag && currentCount === _this.count) {\n          if (_this.loadingDelayTimer) {\n            clearTimeout(_this.loadingDelayTimer);\n          }\n\n          var formattedResult = _this.config.formatResult ? _this.config.formatResult(res) : res;\n\n          _this.setState({\n            data: formattedResult,\n            error: undefined,\n            loading: false\n          });\n\n          if (_this.config.onSuccess) {\n            _this.config.onSuccess(formattedResult, args);\n          }\n\n          return formattedResult;\n        }\n      }).catch(function (error) {\n        if (!_this.unmountedFlag && currentCount === _this.count) {\n          if (_this.loadingDelayTimer) {\n            clearTimeout(_this.loadingDelayTimer);\n          }\n\n          _this.setState({\n            data: undefined,\n            error: error,\n            loading: false\n          });\n\n          if (_this.config.onError) {\n            _this.config.onError(error, args);\n          }\n\n          console.error(error);\n          return error; // throw error;\n        }\n      }).finally(function () {\n        if (!_this.unmountedFlag && currentCount === _this.count) {\n          if (_this.config.pollingInterval) {\n            // 如果屏幕隐藏，并且 !pollingWhenHidden, 则停止轮询，并记录 flag，等 visible 时，继续轮询\n            if (!isDocumentVisible() && !_this.config.pollingWhenHidden) {\n              _this.pollingWhenVisibleFlag = true;\n              return;\n            }\n\n            _this.pollingTimer = setTimeout(function () {\n              _this._run.apply(_this, args);\n            }, _this.config.pollingInterval);\n          }\n        }\n      });\n    }\n  }, {\n    key: \"run\",\n    value: function run() {\n      if (this.debounceRun) {\n        this.debounceRun.apply(this, arguments); // TODO 如果 options 存在 debounceInterval，或 throttleInterval，则 run 和 refresh 不会返回 Promise。 带类型需要修复后，此处变成 return;。\n\n        return Promise.resolve(null);\n      }\n\n      if (this.throttleRun) {\n        this.throttleRun.apply(this, arguments);\n        return Promise.resolve(null);\n      }\n\n      return this._run.apply(this, arguments);\n    }\n  }, {\n    key: \"cancel\",\n    value: function cancel() {\n      if (this.debounceRun) {\n        this.debounceRun.cancel();\n      }\n\n      if (this.throttleRun) {\n        this.throttleRun.cancel();\n      }\n\n      if (this.loadingDelayTimer) {\n        clearTimeout(this.loadingDelayTimer);\n      }\n\n      if (this.pollingTimer) {\n        clearTimeout(this.pollingTimer);\n      }\n\n      this.pollingWhenVisibleFlag = false;\n      this.count += 1;\n      this.setState({\n        loading: false\n      });\n    }\n  }, {\n    key: \"refresh\",\n    value: function refresh() {\n      return this.run.apply(this, _toConsumableArray(this.state.params));\n    }\n  }, {\n    key: \"rePolling\",\n    value: function rePolling() {\n      if (this.pollingWhenVisibleFlag) {\n        this.pollingWhenVisibleFlag = false;\n        this.refresh();\n      }\n    }\n  }, {\n    key: \"mutate\",\n    value: function mutate(data) {\n      if (typeof data === 'function') {\n        this.setState({\n          // eslint-disable-next-line react/no-access-state-in-setstate\n          data: data(this.state.data) || {}\n        });\n      } else {\n        this.setState({\n          data: data\n        });\n      }\n    }\n  }, {\n    key: \"unmount\",\n    value: function unmount() {\n      this.unmountedFlag = true;\n      this.cancel();\n      this.unsubscribe.forEach(function (s) {\n        s();\n      });\n    }\n  }]);\n\n  return Fetch;\n}();\n\nfunction useAsync(service, options) {\n  var _options = options || {};\n\n  var _options$refreshDeps = _options.refreshDeps,\n      refreshDeps = _options$refreshDeps === void 0 ? [] : _options$refreshDeps,\n      _options$manual = _options.manual,\n      manual = _options$manual === void 0 ? false : _options$manual,\n      _options$onSuccess = _options.onSuccess,\n      onSuccess = _options$onSuccess === void 0 ? function () {} : _options$onSuccess,\n      _options$onError = _options.onError,\n      onError = _options$onError === void 0 ? function () {} : _options$onError,\n      _options$defaultLoadi = _options.defaultLoading,\n      defaultLoading = _options$defaultLoadi === void 0 ? false : _options$defaultLoadi,\n      loadingDelay = _options.loadingDelay,\n      _options$pollingInter = _options.pollingInterval,\n      pollingInterval = _options$pollingInter === void 0 ? 0 : _options$pollingInter,\n      _options$pollingWhenH = _options.pollingWhenHidden,\n      pollingWhenHidden = _options$pollingWhenH === void 0 ? true : _options$pollingWhenH,\n      _options$defaultParam = _options.defaultParams,\n      defaultParams = _options$defaultParam === void 0 ? [] : _options$defaultParam,\n      _options$refreshOnWin = _options.refreshOnWindowFocus,\n      refreshOnWindowFocus = _options$refreshOnWin === void 0 ? false : _options$refreshOnWin,\n      _options$focusTimespa = _options.focusTimespan,\n      focusTimespan = _options$focusTimespa === void 0 ? 5000 : _options$focusTimespa,\n      fetchKey = _options.fetchKey,\n      cacheKey = _options.cacheKey,\n      debounceInterval = _options.debounceInterval,\n      throttleInterval = _options.throttleInterval,\n      initialData = _options.initialData;\n  var newstFetchKey = useRef(DEFAULT_KEY); // 持久化一些函数\n\n  var servicePersist = usePersistFn(service);\n  var onSuccessPersist = usePersistFn(onSuccess);\n  var onErrorPersist = usePersistFn(onError);\n  var fetchKeyPersist = usePersistFn(fetchKey);\n  var formatResult;\n\n  if ('formatResult' in _options) {\n    // eslint-disable-next-line prefer-destructuring\n    formatResult = _options.formatResult;\n  }\n\n  var formatResultPersist = usePersistFn(formatResult);\n  var config = {\n    formatResult: formatResultPersist,\n    onSuccess: onSuccessPersist,\n    onError: onErrorPersist,\n    loadingDelay: loadingDelay,\n    pollingInterval: pollingInterval,\n    pollingWhenHidden: pollingWhenHidden,\n    refreshOnWindowFocus: refreshOnWindowFocus,\n    focusTimespan: focusTimespan,\n    debounceInterval: debounceInterval,\n    throttleInterval: throttleInterval\n  };\n  var subscribe = usePersistFn(function (key, data) {\n    setFeches(function (s) {\n      // eslint-disable-next-line no-param-reassign\n      s[key] = data;\n      return _objectSpread({}, s);\n    });\n  }, []);\n\n  var _useState = useState(function () {\n    // 如果有 缓存，则从缓存中读数据\n    if (cacheKey) {\n      var cache = getCache(cacheKey);\n\n      if (cache) {\n        newstFetchKey.current = cache.newstFetchKey;\n        /* 使用 initState, 重新 new Fetch */\n\n        var newFetches = {};\n        Object.keys(cache.fetches).forEach(function (key) {\n          var cacheFetch = cache.fetches[key];\n          var newFetch = new Fetch(servicePersist, config, subscribe.bind(null, key), {\n            loading: cacheFetch.loading,\n            params: cacheFetch.params,\n            data: cacheFetch.data,\n            error: cacheFetch.error\n          });\n          newFetches[key] = newFetch.state;\n        });\n        return newFetches;\n      }\n    }\n\n    return [];\n  }),\n      _useState2 = _slicedToArray(_useState, 2),\n      fetches = _useState2[0],\n      setFeches = _useState2[1];\n\n  var fetchesRef = useRef(fetches);\n  fetchesRef.current = fetches;\n  var run = useCallback(function () {\n    var _currentFetch;\n\n    if (fetchKeyPersist) {\n      var key = fetchKeyPersist.apply(void 0, arguments);\n      newstFetchKey.current = key === undefined ? DEFAULT_KEY : key;\n    }\n\n    var currentFetchKey = newstFetchKey.current; // 这里必须用 fetchsRef，而不能用 fetches。\n    // 否则在 reset 完，立即 run 的时候，这里拿到的 fetches 是旧的。\n\n    var currentFetch = fetchesRef.current[currentFetchKey];\n\n    if (!currentFetch) {\n      var newFetch = new Fetch(servicePersist, config, subscribe.bind(null, currentFetchKey), {\n        data: initialData\n      });\n      currentFetch = newFetch.state;\n      setFeches(function (s) {\n        // eslint-disable-next-line no-param-reassign\n        s[currentFetchKey] = currentFetch;\n        return _objectSpread({}, s);\n      });\n    }\n\n    return (_currentFetch = currentFetch).run.apply(_currentFetch, arguments);\n  }, [fetchKey, subscribe]); // cache\n\n  useEffect(function () {\n    if (cacheKey) {\n      setCache(cacheKey, {\n        fetches: fetches,\n        newstFetchKey: newstFetchKey.current\n      });\n    }\n  }, [cacheKey, fetches]); // 第一次默认执行\n\n  useEffect(function () {\n    if (!manual) {\n      // 如果有缓存\n      if (Object.keys(fetches).length > 0) {\n        /* 重新执行所有的 */\n        Object.values(fetches).forEach(function (f) {\n          f.refresh();\n        });\n      } else {\n        // 第一次默认执行，可以通过 defaultParams 设置参数\n        run.apply(void 0, _toConsumableArray(defaultParams));\n      }\n    }\n  }, []); // 重置 fetches\n\n  var reset = useCallback(function () {\n    Object.values(fetchesRef.current).forEach(function (f) {\n      f.unmount();\n    });\n    newstFetchKey.current = DEFAULT_KEY;\n    setFeches({}); // 不写会有问题。如果不写，此时立即 run，会是老的数据\n\n    fetchesRef.current = {};\n  }, [setFeches]); //  refreshDeps 变化，重新执行所有请求\n\n  useUpdateEffect(function () {\n    if (!manual) {\n      /* 全部重新执行 */\n      Object.values(fetchesRef.current).forEach(function (f) {\n        f.refresh();\n      });\n    }\n  }, _toConsumableArray(refreshDeps)); // 卸载组件触发\n\n  useEffect(function () {\n    return function () {\n      Object.values(fetchesRef.current).forEach(function (f) {\n        f.unmount();\n      });\n    };\n  }, []);\n  var noReady = useCallback(function (name) {\n    return function () {\n      throw new Error(\"Cannot call \".concat(name, \" when service not executed once.\"));\n    };\n  }, []);\n  return _objectSpread({\n    loading: !manual || defaultLoading,\n    data: initialData,\n    error: undefined,\n    params: [],\n    cancel: noReady('cancel'),\n    refresh: noReady('refresh'),\n    mutate: noReady('mutate')\n  }, fetches[newstFetchKey.current] || {}, {\n    run: run,\n    fetches: fetches,\n    reset: reset\n  });\n}\n\nexport default useAsync;","map":{"version":3,"sources":["E:/github-project/cloudMusic-mobile/node_modules/@umijs/use-request/es/useAsync.js"],"names":["_slicedToArray","arr","i","_arrayWithHoles","_iterableToArrayLimit","_nonIterableRest","TypeError","Symbol","iterator","Object","prototype","toString","call","_arr","_n","_d","_e","undefined","_i","_s","next","done","push","value","length","err","Array","isArray","_toConsumableArray","_arrayWithoutHoles","_iterableToArray","_nonIterableSpread","iter","from","arr2","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","apply","_objectSpread","target","arguments","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","obj","configurable","writable","_classCallCheck","instance","Constructor","_defineProperties","props","descriptor","_createClass","protoProps","staticProps","debounce","throttle","useCallback","useEffect","useRef","useState","isDocumentVisible","getCache","setCache","limit","usePersistFn","useUpdateEffect","subscribeFocus","subscribeVisible","DEFAULT_KEY","Fetch","service","config","subscribe","initState","count","unmountedFlag","pollingWhenVisibleFlag","pollingTimer","loadingDelayTimer","unsubscribe","that","state","loading","params","data","error","run","bind","mutate","refresh","cancel","unmount","debounceRun","throttleRun","limitRefresh","debounceInterval","_run","throttleInterval","focusTimespan","pollingInterval","rePolling","refreshOnWindowFocus","setState","s","_this","_len","args","_key","clearTimeout","currentCount","loadingDelay","setTimeout","then","res","formattedResult","formatResult","onSuccess","catch","onError","console","finally","pollingWhenHidden","Promise","resolve","useAsync","options","_options","_options$refreshDeps","refreshDeps","_options$manual","manual","_options$onSuccess","_options$onError","_options$defaultLoadi","defaultLoading","_options$pollingInter","_options$pollingWhenH","_options$defaultParam","defaultParams","_options$refreshOnWin","_options$focusTimespa","fetchKey","cacheKey","initialData","newstFetchKey","servicePersist","onSuccessPersist","onErrorPersist","fetchKeyPersist","formatResultPersist","setFeches","_useState","cache","current","newFetches","fetches","cacheFetch","newFetch","_useState2","fetchesRef","_currentFetch","currentFetchKey","currentFetch","values","f","reset","noReady","name","Error","concat"],"mappings":"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","sourcesContent":["function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); }\n\nfunction _iterableToArrayLimit(arr, i) { if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === \"[object Arguments]\")) { return; } var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\nfunction _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }\n\nfunction _nonIterableSpread() { throw new TypeError(\"Invalid attempt to spread non-iterable instance\"); }\n\nfunction _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter); }\n\nfunction _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\nimport debounce from 'lodash.debounce';\nimport throttle from 'lodash.throttle';\nimport { useCallback, useEffect, useRef, useState } from 'react';\nimport { isDocumentVisible } from './utils';\nimport { getCache, setCache } from './utils/cache';\nimport limit from './utils/limit';\nimport usePersistFn from './utils/usePersistFn';\nimport useUpdateEffect from './utils/useUpdateEffect';\nimport subscribeFocus from './utils/windowFocus';\nimport subscribeVisible from './utils/windowVisible';\nvar DEFAULT_KEY = 'UMIJS_USE_API_DEFAULT_KEY';\n\nvar Fetch = /*#__PURE__*/function () {\n  // 请求时序\n  // 是否卸载\n  // visible 后，是否继续轮询\n  function Fetch(service, config, subscribe, initState) {\n    _classCallCheck(this, Fetch);\n\n    this.config = void 0;\n    this.service = void 0;\n    this.count = 0;\n    this.unmountedFlag = false;\n    this.pollingWhenVisibleFlag = false;\n    this.pollingTimer = undefined;\n    this.loadingDelayTimer = undefined;\n    this.subscribe = void 0;\n    this.unsubscribe = [];\n    this.that = this;\n    this.state = {\n      loading: false,\n      params: [],\n      data: undefined,\n      error: undefined,\n      run: this.run.bind(this.that),\n      mutate: this.mutate.bind(this.that),\n      refresh: this.refresh.bind(this.that),\n      cancel: this.cancel.bind(this.that),\n      unmount: this.unmount.bind(this.that)\n    };\n    this.debounceRun = void 0;\n    this.throttleRun = void 0;\n    this.limitRefresh = void 0;\n    this.service = service;\n    this.config = config;\n    this.subscribe = subscribe;\n\n    if (initState) {\n      this.state = _objectSpread({}, this.state, {}, initState);\n    }\n\n    this.debounceRun = this.config.debounceInterval ? debounce(this._run, this.config.debounceInterval) : undefined;\n    this.throttleRun = this.config.throttleInterval ? throttle(this._run, this.config.throttleInterval) : undefined;\n    this.limitRefresh = limit(this.refresh.bind(this), this.config.focusTimespan);\n\n    if (this.config.pollingInterval) {\n      this.unsubscribe.push(subscribeVisible(this.rePolling.bind(this)));\n    }\n\n    if (this.config.refreshOnWindowFocus) {\n      this.unsubscribe.push(subscribeFocus(this.limitRefresh.bind(this)));\n    }\n  }\n\n  _createClass(Fetch, [{\n    key: \"setState\",\n    value: function setState() {\n      var s = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      this.state = _objectSpread({}, this.state, {}, s);\n      this.subscribe(this.state);\n    }\n  }, {\n    key: \"_run\",\n    value: function _run() {\n      var _this = this;\n\n      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n        args[_key] = arguments[_key];\n      }\n\n      // 取消已有定时器\n      if (this.pollingTimer) {\n        clearTimeout(this.pollingTimer);\n      } // 取消 loadingDelayTimer\n\n\n      if (this.loadingDelayTimer) {\n        clearTimeout(this.loadingDelayTimer);\n      }\n\n      this.count += 1; // 闭包存储当次请求的 count\n\n      var currentCount = this.count;\n      this.setState({\n        loading: !this.config.loadingDelay,\n        params: args\n      });\n\n      if (this.config.loadingDelay) {\n        this.loadingDelayTimer = setTimeout(function () {\n          _this.setState({\n            loading: true\n          });\n        }, this.config.loadingDelay);\n      }\n\n      return this.service.apply(this, args).then(function (res) {\n        if (!_this.unmountedFlag && currentCount === _this.count) {\n          if (_this.loadingDelayTimer) {\n            clearTimeout(_this.loadingDelayTimer);\n          }\n\n          var formattedResult = _this.config.formatResult ? _this.config.formatResult(res) : res;\n\n          _this.setState({\n            data: formattedResult,\n            error: undefined,\n            loading: false\n          });\n\n          if (_this.config.onSuccess) {\n            _this.config.onSuccess(formattedResult, args);\n          }\n\n          return formattedResult;\n        }\n      }).catch(function (error) {\n        if (!_this.unmountedFlag && currentCount === _this.count) {\n          if (_this.loadingDelayTimer) {\n            clearTimeout(_this.loadingDelayTimer);\n          }\n\n          _this.setState({\n            data: undefined,\n            error: error,\n            loading: false\n          });\n\n          if (_this.config.onError) {\n            _this.config.onError(error, args);\n          }\n\n          console.error(error);\n          return error; // throw error;\n        }\n      }).finally(function () {\n        if (!_this.unmountedFlag && currentCount === _this.count) {\n          if (_this.config.pollingInterval) {\n            // 如果屏幕隐藏，并且 !pollingWhenHidden, 则停止轮询，并记录 flag，等 visible 时，继续轮询\n            if (!isDocumentVisible() && !_this.config.pollingWhenHidden) {\n              _this.pollingWhenVisibleFlag = true;\n              return;\n            }\n\n            _this.pollingTimer = setTimeout(function () {\n              _this._run.apply(_this, args);\n            }, _this.config.pollingInterval);\n          }\n        }\n      });\n    }\n  }, {\n    key: \"run\",\n    value: function run() {\n      if (this.debounceRun) {\n        this.debounceRun.apply(this, arguments); // TODO 如果 options 存在 debounceInterval，或 throttleInterval，则 run 和 refresh 不会返回 Promise。 带类型需要修复后，此处变成 return;。\n\n        return Promise.resolve(null);\n      }\n\n      if (this.throttleRun) {\n        this.throttleRun.apply(this, arguments);\n        return Promise.resolve(null);\n      }\n\n      return this._run.apply(this, arguments);\n    }\n  }, {\n    key: \"cancel\",\n    value: function cancel() {\n      if (this.debounceRun) {\n        this.debounceRun.cancel();\n      }\n\n      if (this.throttleRun) {\n        this.throttleRun.cancel();\n      }\n\n      if (this.loadingDelayTimer) {\n        clearTimeout(this.loadingDelayTimer);\n      }\n\n      if (this.pollingTimer) {\n        clearTimeout(this.pollingTimer);\n      }\n\n      this.pollingWhenVisibleFlag = false;\n      this.count += 1;\n      this.setState({\n        loading: false\n      });\n    }\n  }, {\n    key: \"refresh\",\n    value: function refresh() {\n      return this.run.apply(this, _toConsumableArray(this.state.params));\n    }\n  }, {\n    key: \"rePolling\",\n    value: function rePolling() {\n      if (this.pollingWhenVisibleFlag) {\n        this.pollingWhenVisibleFlag = false;\n        this.refresh();\n      }\n    }\n  }, {\n    key: \"mutate\",\n    value: function mutate(data) {\n      if (typeof data === 'function') {\n        this.setState({\n          // eslint-disable-next-line react/no-access-state-in-setstate\n          data: data(this.state.data) || {}\n        });\n      } else {\n        this.setState({\n          data: data\n        });\n      }\n    }\n  }, {\n    key: \"unmount\",\n    value: function unmount() {\n      this.unmountedFlag = true;\n      this.cancel();\n      this.unsubscribe.forEach(function (s) {\n        s();\n      });\n    }\n  }]);\n\n  return Fetch;\n}();\n\nfunction useAsync(service, options) {\n  var _options = options || {};\n\n  var _options$refreshDeps = _options.refreshDeps,\n      refreshDeps = _options$refreshDeps === void 0 ? [] : _options$refreshDeps,\n      _options$manual = _options.manual,\n      manual = _options$manual === void 0 ? false : _options$manual,\n      _options$onSuccess = _options.onSuccess,\n      onSuccess = _options$onSuccess === void 0 ? function () {} : _options$onSuccess,\n      _options$onError = _options.onError,\n      onError = _options$onError === void 0 ? function () {} : _options$onError,\n      _options$defaultLoadi = _options.defaultLoading,\n      defaultLoading = _options$defaultLoadi === void 0 ? false : _options$defaultLoadi,\n      loadingDelay = _options.loadingDelay,\n      _options$pollingInter = _options.pollingInterval,\n      pollingInterval = _options$pollingInter === void 0 ? 0 : _options$pollingInter,\n      _options$pollingWhenH = _options.pollingWhenHidden,\n      pollingWhenHidden = _options$pollingWhenH === void 0 ? true : _options$pollingWhenH,\n      _options$defaultParam = _options.defaultParams,\n      defaultParams = _options$defaultParam === void 0 ? [] : _options$defaultParam,\n      _options$refreshOnWin = _options.refreshOnWindowFocus,\n      refreshOnWindowFocus = _options$refreshOnWin === void 0 ? false : _options$refreshOnWin,\n      _options$focusTimespa = _options.focusTimespan,\n      focusTimespan = _options$focusTimespa === void 0 ? 5000 : _options$focusTimespa,\n      fetchKey = _options.fetchKey,\n      cacheKey = _options.cacheKey,\n      debounceInterval = _options.debounceInterval,\n      throttleInterval = _options.throttleInterval,\n      initialData = _options.initialData;\n  var newstFetchKey = useRef(DEFAULT_KEY); // 持久化一些函数\n\n  var servicePersist = usePersistFn(service);\n  var onSuccessPersist = usePersistFn(onSuccess);\n  var onErrorPersist = usePersistFn(onError);\n  var fetchKeyPersist = usePersistFn(fetchKey);\n  var formatResult;\n\n  if ('formatResult' in _options) {\n    // eslint-disable-next-line prefer-destructuring\n    formatResult = _options.formatResult;\n  }\n\n  var formatResultPersist = usePersistFn(formatResult);\n  var config = {\n    formatResult: formatResultPersist,\n    onSuccess: onSuccessPersist,\n    onError: onErrorPersist,\n    loadingDelay: loadingDelay,\n    pollingInterval: pollingInterval,\n    pollingWhenHidden: pollingWhenHidden,\n    refreshOnWindowFocus: refreshOnWindowFocus,\n    focusTimespan: focusTimespan,\n    debounceInterval: debounceInterval,\n    throttleInterval: throttleInterval\n  };\n  var subscribe = usePersistFn(function (key, data) {\n    setFeches(function (s) {\n      // eslint-disable-next-line no-param-reassign\n      s[key] = data;\n      return _objectSpread({}, s);\n    });\n  }, []);\n\n  var _useState = useState(function () {\n    // 如果有 缓存，则从缓存中读数据\n    if (cacheKey) {\n      var cache = getCache(cacheKey);\n\n      if (cache) {\n        newstFetchKey.current = cache.newstFetchKey;\n        /* 使用 initState, 重新 new Fetch */\n\n        var newFetches = {};\n        Object.keys(cache.fetches).forEach(function (key) {\n          var cacheFetch = cache.fetches[key];\n          var newFetch = new Fetch(servicePersist, config, subscribe.bind(null, key), {\n            loading: cacheFetch.loading,\n            params: cacheFetch.params,\n            data: cacheFetch.data,\n            error: cacheFetch.error\n          });\n          newFetches[key] = newFetch.state;\n        });\n        return newFetches;\n      }\n    }\n\n    return [];\n  }),\n      _useState2 = _slicedToArray(_useState, 2),\n      fetches = _useState2[0],\n      setFeches = _useState2[1];\n\n  var fetchesRef = useRef(fetches);\n  fetchesRef.current = fetches;\n  var run = useCallback(function () {\n    var _currentFetch;\n\n    if (fetchKeyPersist) {\n      var key = fetchKeyPersist.apply(void 0, arguments);\n      newstFetchKey.current = key === undefined ? DEFAULT_KEY : key;\n    }\n\n    var currentFetchKey = newstFetchKey.current; // 这里必须用 fetchsRef，而不能用 fetches。\n    // 否则在 reset 完，立即 run 的时候，这里拿到的 fetches 是旧的。\n\n    var currentFetch = fetchesRef.current[currentFetchKey];\n\n    if (!currentFetch) {\n      var newFetch = new Fetch(servicePersist, config, subscribe.bind(null, currentFetchKey), {\n        data: initialData\n      });\n      currentFetch = newFetch.state;\n      setFeches(function (s) {\n        // eslint-disable-next-line no-param-reassign\n        s[currentFetchKey] = currentFetch;\n        return _objectSpread({}, s);\n      });\n    }\n\n    return (_currentFetch = currentFetch).run.apply(_currentFetch, arguments);\n  }, [fetchKey, subscribe]); // cache\n\n  useEffect(function () {\n    if (cacheKey) {\n      setCache(cacheKey, {\n        fetches: fetches,\n        newstFetchKey: newstFetchKey.current\n      });\n    }\n  }, [cacheKey, fetches]); // 第一次默认执行\n\n  useEffect(function () {\n    if (!manual) {\n      // 如果有缓存\n      if (Object.keys(fetches).length > 0) {\n        /* 重新执行所有的 */\n        Object.values(fetches).forEach(function (f) {\n          f.refresh();\n        });\n      } else {\n        // 第一次默认执行，可以通过 defaultParams 设置参数\n        run.apply(void 0, _toConsumableArray(defaultParams));\n      }\n    }\n  }, []); // 重置 fetches\n\n  var reset = useCallback(function () {\n    Object.values(fetchesRef.current).forEach(function (f) {\n      f.unmount();\n    });\n    newstFetchKey.current = DEFAULT_KEY;\n    setFeches({}); // 不写会有问题。如果不写，此时立即 run，会是老的数据\n\n    fetchesRef.current = {};\n  }, [setFeches]); //  refreshDeps 变化，重新执行所有请求\n\n  useUpdateEffect(function () {\n    if (!manual) {\n      /* 全部重新执行 */\n      Object.values(fetchesRef.current).forEach(function (f) {\n        f.refresh();\n      });\n    }\n  }, _toConsumableArray(refreshDeps)); // 卸载组件触发\n\n  useEffect(function () {\n    return function () {\n      Object.values(fetchesRef.current).forEach(function (f) {\n        f.unmount();\n      });\n    };\n  }, []);\n  var noReady = useCallback(function (name) {\n    return function () {\n      throw new Error(\"Cannot call \".concat(name, \" when service not executed once.\"));\n    };\n  }, []);\n  return _objectSpread({\n    loading: !manual || defaultLoading,\n    data: initialData,\n    error: undefined,\n    params: [],\n    cancel: noReady('cancel'),\n    refresh: noReady('refresh'),\n    mutate: noReady('mutate')\n  }, fetches[newstFetchKey.current] || {}, {\n    run: run,\n    fetches: fetches,\n    reset: reset\n  });\n}\n\nexport default useAsync;"]},"metadata":{},"sourceType":"module"}